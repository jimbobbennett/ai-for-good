<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>LAB GUIDE – includes</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://opsgilitylabs.blob.core.windows.net/lablayout/labstyles.css"></link>
</head>
<body>
<h2 id="exercise-2-ingest-streaming-data-with-iot-hub">Exercise 2: Ingest Streaming Data with IoT Hub</h2>
<p>In this exercise, you will create a storage account and an IoT hub and write a <a href="https://nodejs.org/">Node.js</a> app that connects them to a simulated camera array. Then you will test one of the virtual cameras by having it upload a photograph to blob storage and transmit an event containing the blob URL and other information to the IoT hub.</p>
<p><img src="images/road-map-1.png" /></p>
<h3 id="objectives">Objectives</h3>
<p>In this hands-on lab, you will learn how to:</p>
<ul>
<li>Create an Azure storage account</li>
<li>Create an Azure IoT hub</li>
<li>Make authenticated calls to an Azure IoT hub</li>
<li>Upload images to Azure blob storage from an app or device</li>
</ul>
<h3 id="time-estimate">Time Estimate</h3>
<ul>
<li>30 minutes</li>
</ul>
<h3 id="task-1-create-a-storage-account">Task 1: Create a storage account</h3>
<p>In this task, you will use the Azure CLI to create an Azure storage account in the cloud. This storage account will store as blobs photographs taken by the simulated cameras that you deploy. Note that you can also create storage accounts using the <a href="https://portal.azure.com">Azure Portal</a>. Whether to use the CLI or the portal is often a matter of personal preference.</p>
<ol type="1">
<li><p>First, you will create a resource group to hold the storage account and other Azure resources that make up the solution you’re building.</p>
<p>In a command prompt or terminal window, enter <strong>az login</strong> and log in using your Azure credentials in the window that opens.</p>
<pre><code>az login</code></pre>
<p>Then, execute the following command to create a resource group named “streaminglab-rg” in Azure’s South Central US region:</p>
<pre><code>az group create --name streaminglab-rg --location southcentralus</code></pre></li>
<li><p>Now use the following command to create a general-purpose storage account in the “streaminglab-rg” resource group. Replace ACCOUNT_NAME with the name you wish to assign the storage account. Be sure to make note of it. The account name must be unique within Azure, so if the command fails because the storage-account name is already in use, change the name and try again. In addition, storage-account names must be from 3 to 24 characters in length and can contain only numbers and lowercase letters.</p>
<pre><code>az storage account create --name ACCOUNT_NAME --resource-group streaminglab-rg --location southcentralus --kind StorageV2 --sku Standard_LRS</code></pre></li>
<li><p>Before you can upload blobs to a storage account, you must create a container to store them in. Use the following command to create a container named “photos” in the storage account, replacing ACCOUNT_NAME with the name you assigned to the storage account in the previous step:</p>
<pre><code>az storage container create --name photos --account-name ACCOUNT_NAME</code></pre></li>
</ol>
<p>You now have a storage account for storing photos taken by your simulated cameras, and a container to store them in. Now let’s create an IoT hub to receive events transmitted by the cameras.</p>
<h3 id="task-2-create-an-iot-hub">Task 2: Create an IoT hub</h3>
<p>Azure Stream Analytics supports several types of input, including input from <a href="https://azure.microsoft.com/services/iot-hub/">Azure IoT hubs</a>. In the IoT world, data is easily transmitted to IoT hubs through field gateways (for devices that are not IP-capable) or cloud gateways (for devices that <em>are</em> IP-capable), and a single Azure IoT hub can handle millions of events per second from devices spread throughout the world. IoT hubs support secure two-way communications with the devices connected to them using a variety of transport protocols.</p>
<p>In this exercise, you will create an Azure IoT hub to receive input from a simulated camera array.</p>
<ol type="1">
<li><p>Use the following command to create an IoT Hub in the same region as the storage account you created in the previous task and place it in the “streaminglab-rg” resource group. Replace HUB_NAME with an IoT hub name, which must be unique across Azure and conform to DNS naming conventions. Be sure to make note of the hub name.</p>
<pre><code>az iot hub create --name HUB_NAME --resource-group streaminglab-rg --location southcentralus --sku F1 </code></pre>
<blockquote>
<p>The <code>--sku F1</code> parameter configures the IoT hub to use the free F1 pricing tier, which supports up to 8,000 events per day. However, Azure subscriptions are limited to one free IoT hub each. If the command fails because you have already created a free IoT hub, specify <code>--sku S1</code> instead. The S1 tier greatly expands the message-per-day limit, but is not free.</p>
</blockquote></li>
<li><p>Use the following command to retrieve a connection string for the IoT hub, replacing HUB_NAME with the name you assigned to the IoT hub in the previous step:</p>
<pre><code>az iot hub show-connection-string --name HUB_NAME</code></pre></li>
<li><p>Copy the connection-string value from the output and paste it into a text file so you can retrieve it later. That value will be of the form:</p>
<pre><code>HostName=HUB_NAME.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=KEY_VALUE</code></pre>
<p>Where HUB_NAME is the name of your IoT hub, and KEY_VALUE is the hub’s shared access key.</p></li>
</ol>
<p>The connection string that you just retrieved is important, because it will enable the app that you build in the next exercise to connect to the IoT hub securely and register an array of virtual devices.</p>
<h3 id="task-3-deploy-a-simulated-camera-array">Task 3: Deploy a simulated camera array</h3>
<p>Devices that transmit events to an Azure IoT hub must first be registered with that IoT hub. Once registered, a device can send events to the IoT hub using one of several protocols, including HTTPS, <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf">AMPQ</a>, and <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.pdf">MQTT</a>. Calls must be authenticated, and IoT hubs support several forms of authentication as described in <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-security">Control access to IoT hub</a>. In this task, you will create a Node.js app that registers an array of simulated cameras with the IoT hub you created in the previous exercise.</p>
<ol type="1">
<li><p>From your LABVM, create a directory on your hard disk to serve as the project directory. Then navigate to that directory in a Command Prompt using the below command. Be sure to replace the placeholder text with your directory name.</p>
<pre><code>cd c:\[Your directory name]</code></pre></li>
<li><p>Execute the following commands in sequence to initialize the project directory to host a Node project and install a trio of packages that Node can use to communicate with Azure IoT hubs:</p>
<pre><code>npm init -y</code></pre>
<pre><code>npm install azure-iothub --save</code></pre>
<pre><code>npm install azure-iot-device azure-iot-device-mqtt --save</code></pre>
<p>The <a href="https://www.npmjs.com/package/azure-iothub">azure-iothub</a> package provides APIs for registering devices with IoT hubs and managing device identities, while <a href="https://www.npmjs.com/package/azure-iot-device">azure-iot-device</a> and <a href="https://www.npmjs.com/package/azure-iot-device-mqtt">azure-iot-device-mqtt</a> enable devices to connect to IoT hubs and transmit events using the MQTT protocol.</p></li>
<li><p>Wait for the installs to finish. Then open <strong>Visual Studio Code</strong>, create a new file, and paste in the following json code. Save the file to your project directory and name it <strong>devices.json</strong>.</p>
<pre class="json"><code>[
    {
        &quot;deviceId&quot; : &quot;polar_cam_0001&quot;,
        &quot;latitude&quot; : 75.401451,
        &quot;longitude&quot; : -95.722518,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0002&quot;,
        &quot;latitude&quot; : 75.027715,
        &quot;longitude&quot; : -96.041859,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0003&quot;,
        &quot;latitude&quot; : 74.996653,
        &quot;longitude&quot; : -96.601780,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0004&quot;,
        &quot;latitude&quot; : 75.247701,
        &quot;longitude&quot; : -96.074436,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0005&quot;,
        &quot;latitude&quot; : 75.044926,
        &quot;longitude&quot; : -93.651951,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0006&quot;,
        &quot;latitude&quot; : 75.601571,
        &quot;longitude&quot; : -95.294407,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0007&quot;,
        &quot;latitude&quot; : 74.763102,
        &quot;longitude&quot; : -95.091160,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0008&quot;,
        &quot;latitude&quot; : 75.473988,
        &quot;longitude&quot; : -94.069432,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0009&quot;,
        &quot;latitude&quot; : 75.232307,
        &quot;longitude&quot; : -96.277683,
        &quot;key&quot; : &quot;&quot;
    },
    {
        &quot;deviceId&quot; : &quot;polar_cam_0010&quot;,
        &quot;latitude&quot; : 74.658811,
        &quot;longitude&quot; : -93.783787,
        &quot;key&quot; : &quot;&quot;
    }
]</code></pre>
<p>This file defines ten virtual cameras that will transmit events to the IoT hub. Each “camera” contains a device ID, a latitude and a longitude specifying the camera’s location, and an access key for per-device authentication. The <code>key</code> values are empty for now, but that will change once the cameras are registered with the IoT hub.</p>
<blockquote>
<p>The latitudes and longitudes are for points on the coast of Northern Canada’s <a href="https://en.wikipedia.org/wiki/Cornwallis_Island_(Nunavut)">Cornwallis Island</a>, which is one of the best sites in Canada to spot polar bears. It is also adjacent to <a href="https://en.wikipedia.org/wiki/Bathurst_Island_(Nunavut)">Bathurst Island</a>, which is home to the <a href="https://www.canada.ca/en/environment-climate-change/services/national-wildlife-areas/locations/polar-bear-pass.html">Polar Bear Pass National Wildlife Area</a>.</p>
</blockquote></li>
<li><p>Create another Visual Studio Code file. Enter the following JavaScript code. Then save it your project directory and name it <strong>deploy.js</strong>.</p>
<pre class="javascript"><code>var fs = require(&#39;fs&#39;);
var iothub = require(&#39;azure-iothub&#39;);
var registry = iothub.Registry.fromConnectionString(&#39;CONNECTION_STRING&#39;);

console.log(&#39;Reading devices.json...&#39;);
var devices = JSON.parse(fs.readFileSync(&#39;devices.json&#39;, &#39;utf8&#39;));

console.log(&#39;Registering devices...&#39;);
registry.addDevices(devices, (err, info, res) =&gt; {
    registry.list((err, info, res) =&gt; {
        info.forEach(device =&gt; {
            devices.find(o =&gt; o.deviceId === device.deviceId).key = device.authentication.symmetricKey.primaryKey;          
        });

        console.log(&#39;Writing cameras.json...&#39;);
        fs.writeFileSync(&#39;cameras.json&#39;, JSON.stringify(devices, null, 4), &#39;utf8&#39;);
        console.log(&#39;Done&#39;);
    });
});</code></pre>
<p>This code registers all the simulated devices defined in <strong>devices.json</strong> with the IoT hub that you created earlier. It also retrieves from the IoT hub the access key created for each device and creates a new file named <strong>cameras.json</strong> that contains the same information as <strong>devices.json</strong>, but with a value assigned to each device’s <code>key</code> property. It is this key, which is transmitted in each request, that enables a device to authenticate to the IoT hub.</p></li>
<li><p>Replace CONNECTION_STRING on line 3 of <strong>deploy.js</strong> with the connection string of your IoT Hub that you saved previously. Then save the file.</p></li>
<li><p>Return to the Command Prompt or terminal window and execute the following command to run <strong>deploy.js</strong>:</p>
<pre><code>node deploy.js</code></pre>
<p>Confirm that the output looks like this:</p>
<pre><code>Reading devices.json...
Registering devices...
Writing cameras.json...
Done</code></pre></li>
</ol>
<p>Finish up by verifying that a file named <strong>cameras.json</strong> was created in the project directory open the file and view its contents. Confirm that the <code>key</code> properties which are empty strings in <strong>devices.json</strong> have values in <strong>cameras.json</strong>.</p>
<h2 id="task-4-test-the-simulated-camera-array">Task 4: Test the simulated camera array</h2>
<p>In this task, you will write code to test the camera array that you deployed in the previous task. That code will transmit an event from one of the virtual cameras to the IoT hub, and it will upload an image to the storage account that you created in Task 1.</p>
<ol type="1">
<li><p>Create a subdirectory named “photos” in the project directory that you created in the previous exercise. Then copy all 30 JPG files from <strong>C:\OpsgilityTraining\CameraSimImages</strong> to the “photos” directory. These are the images that the simulated cameras will upload to blob storage, samples of which are shown below. Wildlife depicted in the images include Arctic foxes, polar bears, and walruses.</p>
<p><img src="images/wildlife-images.png" /></p></li>
<li><p>In a Command Prompt or terminal window with the project directory as the current directory, execute the following command to install the <a href="https://www.npmjs.com/package/azure-storage">Microsoft Azure Storage SDK for Node.js</a>:</p>
<pre><code>npm install azure-storage --save</code></pre>
<p>This package provides a programmatic interface to Azure storage, including blob storage.</p></li>
<li><p>Create another Visual Studio Code file. Enter the following code and save it your project directory with the name <strong>test.js</strong>.</p>
<pre class="javascript"><code>var iotHubName = &#39;HUB_NAME&#39;;
var storageAccountName = &#39;ACCOUNT_NAME&#39;;
var storageAccountKey = &#39;ACCOUNT_KEY&#39;;

// Upload an image to blob storage
var azure = require(&#39;azure-storage&#39;);
var blobService = azure.createBlobService(storageAccountName, storageAccountKey);

blobService.createBlockBlobFromLocalFile(&#39;photos&#39;, &#39;image_19.jpg&#39;, &#39;photos/image_19.jpg&#39;, (err, result, response) =&gt; {
    if (err) {
        console.log(&#39;Error uploading blob: &#39; + err);
    }
    else {
        console.log(&quot;Blob uploaded&quot;);

        // Get information about polar_cam_0003 from cameras.js
        var fs = require(&#39;fs&#39;);
        var cameras = JSON.parse(fs.readFileSync(&#39;cameras.json&#39;, &#39;utf8&#39;));
        var camera = cameras.find(o =&gt; o.deviceId === &#39;polar_cam_0003&#39;);

        // Send an event to the IoT hub and include the blob&#39;s URL
        var Message = require(&#39;azure-iot-device&#39;).Message;
        var connectionString = &#39;HostName=&#39; + iotHubName + &#39;.azure-devices.net;DeviceId=&#39; + camera.deviceId + &#39;;SharedAccessKey=&#39; + camera.key;
        var clientFromConnectionString = require(&#39;azure-iot-device-mqtt&#39;).clientFromConnectionString;
        var client = clientFromConnectionString(connectionString);

        client.open(err =&gt; {
            if (err) {
                console.log(&#39;Error connecting to IoT hub: &#39; + err);
            }
            else {
                var data = {
                    &#39;deviceId&#39; : camera.deviceId,
                    &#39;latitude&#39; : camera.latitude,
                    &#39;longitude&#39; : camera.longitude,
                    &#39;url&#39; : &#39;https://&#39; + storageAccountName + &#39;.blob.core.windows.net/photos/image_19.jpg&#39;,
                    &#39;timestamp&#39; : new Date().toISOString()
                };

                var message = new Message(JSON.stringify(data));

                client.sendEvent(message, (err, result) =&gt; {
                    if (err) {
                        console.log(&#39;Error sending event: &#39; + err);
                    }
                    else {
                        console.log(&quot;Event transmitted&quot;);                
                    }
                });
            }
        });
    }
});</code></pre>
<p>This code uploads the file named <strong>image_19.jpg</strong> from the current directory’s “photos” subdirectory to the storage account’s “photos” container. Then it opens a connection from <code>polar_cam_0003</code> to the IoT hub using <code>polar_cam_0003</code>’s access key (which comes from <strong>cameras.js</strong>) and transmits a message containing a JSON payload over MQTT. That message includes a camera ID, a latitude and longitude, the URL of the blob that was uploaded, and the event time.</p></li>
<li><p>Replace HUB_NAME on line 1 of <strong>test.js</strong> with the name of the IoT hub you created in Task 2, and ACCOUNT_NAME on line 2 with the name of the storage account that you created in Task 1. If necessary, you can find these values by navigating to the <strong>streaminglab-rg</strong> resource group in the Azure Portal. Save the file.</p></li>
<li><p>Return to the Command Prompt or terminal window and use the following command to list the access keys for the storage account, replacing ACCOUNT_NAME with the name of your storage account:</p>
<pre><code>az storage account keys list --account-name ACCOUNT_NAME --resource-group streaminglab-rg</code></pre>
<p>By default, blobs stored in an Azure storage account are private and are only accessible to persons who have access to the subscription under which the account was created. Access keys allow other parties, including apps, to access the contents of a storage account. You should treat access keys with great care and <strong>never</strong> give them to someone you don’t trust.</p></li>
<li><p>Copy the <code>value</code> property of either of the two keys that is displayed in the command output to the clipboard. Then replace ACCOUNT_KEY on line 3 of <strong>test.js</strong> with the access key. That line should now look something like this:</p>
<pre class="javascript"><code>&quot;value&quot;: &quot;doPZd+uLueiDMY0JWtg...qWtWfmJLVkTe/huqlTliq8ruy8L1lzmDV9l6HkRw==&quot;</code></pre></li>
<li><p>Save <strong>test.js</strong>, and then run it with the following command:</p>
<pre><code>node test.js</code></pre>
<p>Confirm that you see the following output indicating that the command completed successfully:</p>
<pre><code>Blob uploaded
Event transmitted</code></pre></li>
<li><p>Open a browser and log into the Azure Portal (https://portal.azure.com) in your browser if you haven’t already.</p></li>
<li><p>Click <strong>Resource groups</strong> in the left navigation, and then click the <strong>streaminglab-rg</strong> resource group to view its contents.</p>
<p><img src="images/open-resource-group.png" /></p></li>
<li><p>Click the storage account that you created in Task 1.</p>
<p><img src="images/open-storage-account.png" /></p></li>
<li><p>In the blade for the storage account, click <strong>Containers</strong> to view a list of blob containers.</p>
<p><img src="images/open-blob-storage.png" /></p></li>
<li><p>Click <strong>photos</strong> to open the “photos” container.</p>
<p><img src="images/open-container.png" /></p></li>
<li><p>Click the blob named <strong>image_19.jpg</strong>.</p>
<p><img src="images/open-blob.png" /></p></li>
<li><p>Click <strong>Download</strong> to download the blob. Confirm that it contains a small (64x64) grayscale polar-bear image.</p>
<p><img src="images/download-blob.png" /></p></li>
<li><p>Return to the <strong>streaminglab-rg</strong> resource group in the portal and click the IoT hub.</p>
<p><img src="images/open-iot-hub.png" /></p></li>
<li><p>Scroll down and confirm that at least one message has been received by the IoT hub, and that it has 10 devices registered. These are the simulated cameras that you registered in the previous exercise.</p>
<p><img src="images/2018-10-19-17-29-40.png" /></p></li>
</ol>
<p>If you would like to see a list of devices registered with the IoT hub, click <strong>IoT Devices</strong> in the menu on the left. If you then click one of the devices, you will find that individual devices can be enabled and disabled through the portal. Devices can also be enabled and disabled using the Azure CLI.</p>
<h2 id="summary">Summary</h2>
<p>In this exercise, you created an Azure IoT hub, registered an array of simulated devices, and sent a message to the IoT hub from one of the devices to confirm that everything was set up correctly. You also created an Azure storage account and a blob container inside it and demonstrated that a device simulated in software could upload blobs to it.</p>
<hr />
<p>Copyright 2018 Microsoft Corporation. All rights reserved. Except where otherwise noted, these materials are licensed under the terms of the MIT License. You may use them according to the license as is most appropriate for your project. The terms of this license can be found at https://opensource.org/licenses/MIT.</p>
</body>
</html>
